apiVersion: v1
kind: ServiceAccount
metadata:
  name: audit-runner
  namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: audit-runner-impersonate
rules:
  - apiGroups: [""]  
    resources: ["users", "groups", "serviceaccounts"]
    verbs: ["impersonate"]
  - apiGroups: ["authorization.k8s.io"]
    resources: ["selfsubjectaccessreviews", "selfsubjectrulesreviews"]
    verbs: ["create"]
  - apiGroups: [""]
    resources: ["pods", "pods/log"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["batch"]
    resources: ["jobs"]
    verbs: ["get", "list", "create", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: audit-runner-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
  - kind: ServiceAccount
    name: audit-runner
    namespace: default
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: audit-runner-impersonate-binding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: audit-runner-impersonate
subjects:
  - kind: ServiceAccount
    name: audit-runner
    namespace: default
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: k8s-security-dashboard
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: k8s-security-dashboard
  template:
    metadata:
      labels:
        app: k8s-security-dashboard
    spec:
      tolerations:
      - operator: "Exists"
      serviceAccountName: audit-runner
      containers:
        - name: dashboard
          image: mohanvamsi06/fyp:v0.0.1 
          imagePullPolicy: Always
          ports:
            - containerPort: 5000
              name: http
          volumeMounts:
            - name: output
              mountPath: /output
          env:
            - name: RESULT_JSON_PATH
              value: "/output/results.json"
        - name: tetragon-collector
          image: bitnami/kubectl:latest
          securityContext:
            runAsUser: 0
          command: ["/bin/bash", "-c"]
          args:
            - |
              OUTPUT_FILE="/output/runtime_alerts.json"
              echo "[+] Starting Tetragon log collection..."
              
              # Create file with proper permissions
              touch "$OUTPUT_FILE"
              chmod 666 "$OUTPUT_FILE"
              
              # Wait for Tetragon to be ready
              until kubectl get pods -n tetragon -l app.kubernetes.io/name=tetragon 2>/dev/null | grep -q Running; do
                echo "Waiting for Tetragon pods..."
                sleep 5
              done
              
              echo "[+] Tetragon pods found, starting log collection..."
              echo "[+] Monitoring DOS events: bind, accept, clone, connect, fd"
              
              # Capture all events and write to file
              kubectl logs -n tetragon -l app.kubernetes.io/name=tetragon --follow --tail=0 2>/dev/null | \
              while IFS= read -r line; do
                # Check if it's valid JSON
                if echo "$line" | jq -e . >/dev/null 2>&1; then
                  # Write all events to file (we'll filter in the dashboard)
                  echo "$line" >> "$OUTPUT_FILE"
                  
                  # Log to stdout for debugging
                  binary=$(echo "$line" | jq -r '.process_exec.process.binary // .process_tracepoint.process.binary // "unknown"' 2>/dev/null)
                  subsys=$(echo "$line" | jq -r '.process_tracepoint.subsys // "N/A"' 2>/dev/null)
                  event=$(echo "$line" | jq -r '.process_tracepoint.event // "N/A"' 2>/dev/null)
                  
                  echo "[EVENT] subsys=$subsys event=$event binary=$binary"
                fi
              done
          volumeMounts:
            - name: output
              mountPath: /output
      volumes:
        - name: output
          hostPath:
            path: /var/tmp/results
            type: DirectoryOrCreate
---
apiVersion: v1
kind: Service
metadata:
  name: k8s-security-dashboard
  namespace: default
spec:
  type: NodePort
  selector:
    app: k8s-security-dashboard
  ports:
    - port: 5000
      targetPort: 5000
      nodePort: 30500
      protocol: TCP
      name: http
